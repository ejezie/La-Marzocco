<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Product Wise Report</title>
    <!-- Bootstrap -->
    <link href="cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- iCheck -->
    <link href="../vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <!-- bootstrap-daterangepicker -->
    <link href="../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css" rel="stylesheet">
    <!-- Admin Dashboard Custom CSS -->
    <link href="css/adminDashboard.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <div class="col-md-3 left_col">
                <div class="left_col scroll-view" id="accordionSidebar">
                    <!-- /menu footer buttons -->
                </div>
            </div>
            <!-- top navigation -->
            <div class="top_nav">
                <div class="nav_menu">
                    <div class="nav toggle">
                        <a id="menu_toggle" style="padding-bottom: 15px;"><i class="fa fa-bars"></i></a>
                    </div>
                </div>
            </div>
            <!-- /top navigation -->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="">
                    <div class="page-title">
                        <div class="title_left">
                            <h3>Report</h3>
                        </div>
                    </div>
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12 ">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>Product Wise Report</h2>
                                    <button type="button" class="btn " data-toggle="modal" data-target="#myModal" style="float:right;margin-right: 10px;">Mail</button>
                                    <!-- Modal -->
                                    <div class="modal fade" id="myModal" role="dialog">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal">&times;</button><br>
                                                    <!-- <h4 class="modal-title">Modal Header</h4> -->
                                                </div>
                                                <div class="modal-body">
                                                    <!-- <p>This is a large modal.</p> -->
                                                    <div class="container">
                                                        <div class="col-md-2"></div>
                                                        <div class="col-md-8">
                                                            <div class="card">
                                                                <div class="card-header">
                                                                    <h3>Send Email</h3>
                                                                </div>
                                                                <div class="card-body">
                                                                    <div class="form-row">
                                                                        <label>Start Date</label>
                                                                         <input type="date" class="form-control" id="start_mail_date" placeholder="Date" />
                                                                    </div>
                                                                    <br>
                                                                    <div class="form-row">
                                                                        <label>End Date</label>
                                                                        <input type="date" class="form-control" id="end_mail_date" placeholder="Date" />
                                                                        <!-- </div> -->
                                                                    </div>
                                                                    <br>
                                                                    <div class="form-row">
                                                                        <label>Select Mail Option</label>
                                                                        <select class="form-control" id="file_type">
                                                                            <option value="">Choose One</option>
                                                                            <option value="2">Pdf</option>
                                                                            <option value="1">Excel</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div class="card-footer">
                                                                    <center><button class="btn btn-primary" id="send_mail">Send Mail</button></center>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2"></div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc">
                                        <i class="fa fa-calendar"></i>
                                        <span></span> <b class="caret"></b>
                                    </div>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="card-box table-responsive">
                                                <p class="text-muted font-13 m-b-30">
                                                    Product wise sales accross all regions.
                                                </p>
                                                <table id="tableProductReport" class="table table-striped table-bordered" style="width:100%">
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /page content -->
    <!-- footer content -->
    <footer>
        <div class="pull-right">
            <!-- Gentelella - Bootstrap Admin Template by <a href="https://colorlib.com">Colorlib</a> -->
            <p> &copy; 2020 <a href="#">La Marzocco enabled by PCPL</a></p>
        </div>
        <div class="clearfix"></div>
    </footer>
    <!-- /footer content -->
    </div>
    </div>
    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- iCheck -->
    <script src="../vendors/iCheck/icheck.min.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <!-- bootstrap-daterangepicker -->
    <script src="../vendors/moment/min/moment.min.js"></script>
    <script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
    <!-- Side NavBar -->
    <script src="js/sideNavBar.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script src="../config.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script src="../assets/js/common/localstorage.js"></script>
    <script src="../assets/js/common/notification.js"></script>
    <script src="../assets/js/common/api.js"></script>
    <script src="assets/js/cart.js"></script>
    <script>
    $(document).ready(function() {
        $("#send_mail").click(function() {
            var start_mail_date = $("#start_mail_date").val();
            var end_mail_date = $("#end_mail_date").val();
            var file = $("#file_type").val();
            var onError = function(error) {
                notifyError("Failed to sent Mail");
            };
            var onResponse = function(response) {
                if (response.data.status == true) {
                    notifySuccess("Mail sent successfully!");
                    window.location.reload();
                } else {
                    notifyError(response.data.message);
                }
            };
            sendMailProductWiseReport(onResponse, onError, start_mail_date, end_mail_date, file);
        });
    });

    function initDatePicker(start_date, end_date) {
        var cb = function(start, end, label) {
            console.log(start.toISOString(), end.toISOString(), label);
            $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
        };

        var optionSet1 = {
            startDate: moment().subtract(29, 'days'),
            endDate: moment(),
            // minDate: '01/01/2012',
            // maxDate: '12/31/2015',
            dateLimit: {
                days: 1000
            },
            showDropdowns: true,
            showWeekNumbers: true,
            timePicker: false,
            timePickerIncrement: 1,
            timePicker12Hour: true,
            opens: 'left',
            buttonClasses: ['btn btn-default'],
            applyClass: 'btn-small btn-primary',
            cancelClass: 'btn-small',
            format: 'MM/DD/YYYY',
            separator: ' to ',
            locale: {
                applyLabel: 'Submit',
                cancelLabel: 'Clear',
                fromLabel: 'From',
                toLabel: 'To',
                customRangeLabel: 'Custom',
                daysOfWeek: ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'],
                monthNames: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                firstDay: 1
            }
        };

        if (start_date && end_date) {
            $('#reportrange span').html(start_date + ' to ' + end_date);
        } else {
            // $('#reportrange span').html("Last 30 days")
            $('#reportrange span').html("Apply Date Filter")
        }

        $('#reportrange').daterangepicker(optionSet1, cb);
        $('#reportrange').on('show.daterangepicker', function() {
            console.log("show event fired");
        });
        $('#reportrange').on('hide.daterangepicker', function() {
            console.log("hide event fired");
        });
        $('#reportrange').on('apply.daterangepicker', function(ev, picker) {
            console.log("apply event fired, start/end dates are " + picker.startDate.format('YYYY-MM-DD') + " to " + picker.endDate.format('YYYY-MM-DD'));
            var start_date = picker.startDate.format('YYYY-MM-DD');
            var end_date = picker.endDate.format('YYYY-MM-DD');
            // window.location.href = '../adminDashboard/dashboard.html?start_date='+start_date+'&end_date='+end_date;


            showTable(start_date, end_date)
        });
        $('#reportrange').on('cancel.daterangepicker', function(ev, picker) {
            console.log("cancel event fired");
        });
        $('#options1').click(function() {
            $('#reportrange').data('daterangepicker').setOptions(optionSet1, cb);
        });
        $('#options2').click(function() {
            $('#reportrange').data('daterangepicker').setOptions(optionSet2, cb);
        });
        $('#destroy').click(function() {
            $('#reportrange').data('daterangepicker').remove();
        });
    }



    async function showTable(startDate, endDate) {

        itemMasterTable = $('#tableProductReport').DataTable({
            dom: 'Blfrtip',
            "bDestroy": true,
            searching: true,
            processing: true,
            serverSide: true,
            pageLength: 10,
            // bSort : false,
            lengthMenu: [
                [10, 20, 500, 1000, -1],
                [10, 20, 500, 1000, "All"]
            ],
            columnDefs: [{
                    orderable: true,
                    // className: 'select-checkbox',
                    targets: 0
                },
                {
                    'targets': [1, 2, 3, 4], // column index (start from 0)
                    'orderable': false, // set orderable false for selected columns
                },
                {
                    targets: '_all',
                    defaultContent: '-'
                },
            ],
            select: {
                style: 'multi',
                selector: 'td:first-child'
            },
            order: [
                [0, 'asc']
            ],
            ajax: function(data, callback, settings) {
                const loadingId = notifyInfo("Please wait");
                var onResponse = function(res) {

                    dismiss(loadingId);
                    callback({
                        draw: data.draw,
                        recordsTotal: res.data.report.total,
                        recordsFiltered: res.data.report.total,
                        data: res.data.report.data
                    });

                };
                var onError = function(error) {
                    console.log(error);
                    dismiss(loadingId);
                };
                // var pageIndex = data.start / data.length + 1 ;

                var sort_key;
                if (data.order && data.order.length > 0) {
                    columnIndex = data.order[0].column; //alert(columnIndex)
                    columnSortType = data.order[0].dir; //alert(columnIndex)

                    if (columnIndex == 0) {
                        sort_key = "sort_by_code";
                    } else
                    if (columnIndex == 5) {
                        sort_key = "sort_by_orders";
                    } else
                    if (columnIndex == 6) {
                        sort_key = "sort_by_sales";
                    }


                    if (columnSortType == 'asc') {
                        sort_value = 1
                    } else if (columnSortType == 'desc') {
                        sort_value = 0
                    }

                }

                const searchQuery = data.search.value;
                if (searchQuery && searchQuery.length < 3) {
                    // notifyError("The search text must be at least 3 characters");
                    // return;
                }
                var pageIndex = data.start / data.length + 1;
                console.log("apgedinnnnnnnnnnndex  " + JSON.stringify(data, null, 2))
                if (startDate && endDate) {
                    getProductwiseReport(onResponse, startDate, endDate, null, pageIndex, data.length, searchQuery, sort_key, sort_value, onError);
                } else {
                    getProductwiseReport(onResponse, null, null, null, pageIndex, data.length, searchQuery, sort_key, sort_value, onError);

                }
            },

            buttons: [


                {
                    text: 'PDF',
                    action: async function() {


                        var onResponse = function(res) {
                            console.log("resssssss : ", res)
                            if (res.data.report) {
                                window.location.href = res.data.report
                            }

                        };
                        var onError = function(error) {
                            console.log(error);
                            dismiss(loadingId);
                        };
                        // var pageIndex = data.start / data.length + 1 ;
                        var download_format = 2
                        if (startDate && endDate) {
                            getProductwiseReport(onResponse, startDate, endDate, download_format);
                        } else {
                            getProductwiseReport(onResponse, null, null, download_format);
                        }
                    }

                },
                {
                    text: 'CSV',
                    action: async function() {


                        var onResponse = function(res) {
                            console.log("resssssss : ", res)
                            if (res.data.report) {
                                window.location.href = res.data.report
                                // window.location.href='https://file-examples-com.github.io/uploads/2017/02/file_example_XLS_10.xls'
                            }

                        };
                        var onError = function(error) {
                            console.log(error);
                            dismiss(loadingId);
                        };
                        // var pageIndex = data.start / data.length + 1 ;
                        var download_format = 1
                        if (startDate && endDate) {
                            getProductwiseReport(onResponse, startDate, endDate, download_format);
                        } else {
                            getProductwiseReport(onResponse, null, null, download_format);
                        }
                    }

                },
            ],
            columns: [

                {
                    "title": "Item Code",
                    render: function(data, type, row, meta) {
                        // console.log(JSON.stringify(row,null,2))
                        return safeAccess(['code'], row, "-");
                    }
                },
                {
                    "title": "Item Name",
                    render: function(data, type, row, meta) {
                        // console.log(JSON.stringify(row,null,2))
                        return safeAccess(['name'], row, "-")
                    }
                },
                {
                    "title": "Type",
                    render: function(data, type, row) {
                        return safeAccess(['type'], row, "-");
                    }
                },
                {
                    "title": "Group Name",
                    render: function(data, type, row) {
                        return safeAccess(['group_name'], row, "-");
                    }
                },
                {
                    "title": "Group Description",
                    render: function(data, type, row) {
                        return safeAccess(['group_desc'], row, "-");
                    }
                },
                {
                    "title": "Orders",
                    render: function(data, type, row) {
                        return safeAccess(['orders'], row, "-");
                    }
                },
                {
                    "title": "Sales",
                    render: function(data, type, row) {
                        return "$" + safeAccess(['sales'], row, "-").toLocaleString("en-AU")
                    }
                }
            ]
        })
    }
    $(document).ready(function() {

        var start_date = findGetParameter("start_date");
        var end_date = findGetParameter("end_date");
        initDatePicker(start_date, end_date);

        showTable()

    });
    </script>
</body>

</html>